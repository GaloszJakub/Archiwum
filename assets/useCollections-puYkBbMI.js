import{C as d,n as c,aD as v,y as m,H as y,E as A,G as q,l as C,a4 as D,aC as f,z as h,u as a,a as I,t as p,v as w}from"./index-Do5FezME.js";class F{async createCollection(e,t,o){const i=d(c,"users",e,"collections");return(await v(i,{name:t,description:o||"",createdAt:m.now(),updatedAt:m.now(),itemCount:0})).id}async getUserCollections(e){const t=d(c,"users",e,"collections");return(await y(t)).docs.map(i=>({id:i.id,name:i.data().name,description:i.data().description,createdAt:i.data().createdAt.toDate(),updatedAt:i.data().updatedAt.toDate(),itemCount:i.data().itemCount||0}))}async addItemToCollection(e,t,o){const i=d(c,"users",e,"collections",t,"items"),n=A(i,q("tmdbId","==",o.tmdbId),q("type","==",o.type));if(!(await y(n)).empty)throw new Error("Item already in collection");await v(i,{...o,addedAt:m.now()});const r=C(c,"users",e,"collections",t),R=(await D(r)).data()?.itemCount||0;await f(r,{itemCount:R+1,updatedAt:m.now()})}async removeItemFromCollection(e,t,o){const i=C(c,"users",e,"collections",t,"items",o);await h(i);const n=C(c,"users",e,"collections",t),r=(await D(n)).data()?.itemCount||0;await f(n,{itemCount:Math.max(0,r-1),updatedAt:m.now()})}async getCollectionItems(e,t){const o=d(c,"users",e,"collections",t,"items");return(await y(o)).docs.map(n=>({id:n.id,tmdbId:n.data().tmdbId,type:n.data().type,title:n.data().title,posterPath:n.data().posterPath,addedAt:n.data().addedAt.toDate()}))}async isItemInCollection(e,t,o,i){const n=d(c,"users",e,"collections",t,"items"),u=A(n,q("tmdbId","==",o),q("type","==",i));return!(await y(u)).empty}async deleteCollection(e,t){const o=d(c,"users",e,"collections",t,"items"),n=(await y(o)).docs.map(r=>h(r.ref));await Promise.all(n);const u=C(c,"users",e,"collections",t);await h(u)}async updateCollection(e,t,o){const i=C(c,"users",e,"collections",t);await f(i,{...o,updatedAt:m.now()})}}const l=new F,K=()=>{const{user:s}=a();return I({queryKey:["collections",s?.uid],queryFn:()=>l.getUserCollections(s.uid),enabled:!!s,staleTime:300*1e3})},b=s=>{const{user:e}=a();return I({queryKey:["collection-items",e?.uid,s],queryFn:()=>l.getCollectionItems(e.uid,s),enabled:!!e&&!!s,staleTime:300*1e3})},S=()=>{const{user:s}=a(),e=p();return w({mutationFn:({name:t,description:o})=>l.createCollection(s.uid,t,o),onSuccess:()=>{e.invalidateQueries({queryKey:["collections",s?.uid]})}})},T=()=>{const{user:s}=a(),e=p();return w({mutationFn:({collectionId:t,item:o})=>l.addItemToCollection(s.uid,t,o),onSuccess:(t,o)=>{e.invalidateQueries({queryKey:["collections",s?.uid]}),e.invalidateQueries({queryKey:["collection-items",s?.uid,o.collectionId]}),e.invalidateQueries({queryKey:["item-in-collections",s?.uid]})}})},P=()=>{const{user:s}=a(),e=p();return w({mutationFn:({collectionId:t,itemId:o})=>l.removeItemFromCollection(s.uid,t,o),onSuccess:(t,o)=>{e.invalidateQueries({queryKey:["collections",s?.uid]}),e.invalidateQueries({queryKey:["collection-items",s?.uid,o.collectionId]})}})},x=()=>{const{user:s}=a(),e=p();return w({mutationFn:t=>l.deleteCollection(s.uid,t),onSuccess:()=>{e.invalidateQueries({queryKey:["collections",s?.uid]})}})},U=()=>{const{user:s}=a(),e=p();return w({mutationFn:({collectionId:t,updates:o})=>l.updateCollection(s.uid,t,o),onSuccess:()=>{e.invalidateQueries({queryKey:["collections",s?.uid]})}})},k=(s,e)=>{const{user:t}=a(),{data:o}=K();return I({queryKey:["item-in-collections",t?.uid,s,e],queryFn:async()=>!o||!t?[]:(await Promise.all(o.map(async n=>{const u=await l.isItemInCollection(t.uid,n.id,s,e);return{collectionId:n.id,isInCollection:u}}))).filter(n=>n.isInCollection).map(n=>n.collectionId),enabled:!!t&&!!o&&o.length>0,staleTime:30*1e3})};export{S as a,x as b,U as c,b as d,P as e,k as f,T as g,K as u};

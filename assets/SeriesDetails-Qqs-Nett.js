import{u as C,a as Le,t as ze,v as Pe,r,w as Ee,j as e,D as G,d as Oe,B as f,e as J,f as $e,g as K,h as Te,I as Fe,i as Y,k as S,l as Be,s as Ue,n as qe,o as We,p as Z,q as Re,b as Ve,x as Ie,m as Me}from"./index-Do5FezME.js";import{n as He,o as Qe}from"./useTMDB-B4-GA8KA.js";import{t as X}from"./tmdb-asYHfBOd.js";import{A as Ge}from"./AddToCollectionButton-CWatftT8.js";import{L as D}from"./label-qC8oY3ar.js";import{l as Je,m as Ke,n as Ye,c as Ze,P as ee,A as se,d as ae,e as ne,f as ie,g as te,h as le,i as re,j as oe,S as Xe,C as es,k as ss,R as as}from"./ScraperButton-OVTpODP3.js";import{S as O,a as $,b as T,c as F,d as j}from"./select-CiDdtluD.js";import{w as ue}from"./watchedEpisodes-DNUvklX3.js";import{P as ce}from"./plus-pGei4JVk.js";import{A as de}from"./arrow-left-BH0XIAJO.js";import{S as ns}from"./star-PWIeYpDw.js";import"./useCollections-puYkBbMI.js";import"./pl-lAGqhVVr.js";import"./pen-CPGXu6R4.js";const is=i=>{const{user:t}=C();return Le({queryKey:["watchedEpisodes",t?.uid,i],queryFn:()=>ue.getWatchedEpisodesForShow(t.uid,i),enabled:!!t&&!!i,staleTime:30*1e3})},ts=()=>{const{user:i}=C(),t=ze();return Pe({mutationFn:({tmdbId:p,seasonNumber:s,episodeNumber:b})=>i?ue.markAsWatched(i.uid,p,s,b):Promise.reject(new Error("User not logged in")),onSuccess:(p,s)=>{t.invalidateQueries({queryKey:["watchedEpisodes",i?.uid,s.tmdbId]})},onError:p=>{}})},ls=({targetEpisode:i,tmdbId:t,seasonNumber:p,shouldScroll:s})=>{r.useEffect(()=>{if(s&&i){let b=0;const k=20,c=()=>{const v=`episode-${t}-s${p}-e${i}`,d=document.getElementById(v);if(d){const x=Ee();x?x.scrollTo(d,{offset:-100,duration:1.5}):d.scrollIntoView({behavior:"smooth",block:"center"});const h=["!bg-green-500/5"];d.classList.add(...h)}else b<k&&(b++,setTimeout(c,100))};setTimeout(c,500)}},[i,t,p,s])},rs=({tmdbId:i,seasonNumber:t,episodeCount:p,seasonName:s,seriesName:b,targetEpisode:k})=>{const{isAdmin:c,user:v}=C(),[d,x]=r.useState(!1),[h,u]=r.useState(1),[n,g]=r.useState(""),[m,me]=r.useState("1080p"),[B,pe]=r.useState("PL"),[N,U]=r.useState(!1),[xe,he]=r.useState(""),[ge,A]=r.useState(!1),[q,W]=r.useState(null),[je,L]=r.useState(!1),[R,V]=r.useState(null),{data:fe,isLoading:I}=Je(i,t),{data:z,isLoading:M}=He(i,t),H=Ke(),P=Ye(),{data:be}=is(i),ve=ts(),ye=new Set(be?.map(a=>`${a.seasonNumber}_${a.episodeNumber}`)||[]);Ze(N),r.useEffect(()=>{if(d||N){We();const a=window.innerWidth-document.documentElement.clientWidth;document.body.style.overflow="hidden",document.body.style.paddingRight=`${a}px`}else Z(),document.body.style.overflow="",document.body.style.paddingRight="";return()=>{Z(),document.body.style.overflow="",document.body.style.paddingRight=""}},[d,N]),ls({targetEpisode:k,tmdbId:i,seasonNumber:t,shouldScroll:!I&&!M&&!!z?.episodes});const Q=(a,l,o)=>{o.preventDefault(),he(a),U(!0),v&&ve.mutate({tmdbId:i,seasonNumber:t,episodeNumber:l})},ke=async()=>{if(!n.trim())return;const a=z?.episodes?.find(l=>l.episode_number===h)?.name||"";try{await H.mutateAsync({tmdbId:i,seasonNumber:t,episodeNumber:h,link:n.trim(),options:{title:a,quality:m,language:B}}),g(""),x(!1),S.success("Sukces",{description:`Odcinek ${h} - ${m}`})}catch{S.error("Błąd",{description:"Spróbuj ponownie"})}},we=a=>{V(a),L(!0)},Ne=async()=>{if(R===null)return;L(!1);const a=R;V(null),S.promise(P.mutateAsync({tmdbId:i,seasonNumber:t,episodeNumber:a}),{loading:"Usuwanie wszystkich linków...",success:"Wszystkie linki usunięte",error:"Błąd podczas usuwania"})},_e=(a,l)=>{W({episodeNumber:a,linkIndex:l}),A(!0)},Se=async()=>{if(!q)return;const{episodeNumber:a,linkIndex:l}=q,o=_.get(a);!o||!o.links||(A(!1),W(null),S.promise((async()=>{const y=o.links.filter((os,Ae)=>Ae!==l);if(y.length===0){await P.mutateAsync({tmdbId:i,seasonNumber:t,episodeNumber:a});return}const w=`${i}_s${t}_e${a}`,Ce=Be(qe,"episodes",w),E=y[0];await Ue(Ce,{...o,link:E.url,quality:E.quality||"720p",language:E.version||"PL",links:y,updatedAt:new Date},{merge:!0}),await P.mutateAsync({tmdbId:i,seasonNumber:t,episodeNumber:a})})(),{loading:"Usuwanie linku...",success:"Link usunięty",error:"Błąd podczas usuwania linku"}))},De=Array.from({length:p},(a,l)=>l+1),_=new Map(fe?.map(a=>[a.episodeNumber,a])||[]);return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-lg font-semibold",children:s}),c&&e.jsxs(G,{open:d,onOpenChange:x,modal:!0,children:[e.jsx(Oe,{asChild:!0,children:e.jsxs(f,{size:"sm",variant:"outline",children:[e.jsx(ce,{className:"w-4 h-4 mr-2"}),"Dodaj link"]})}),e.jsxs(J,{className:"max-h-[90vh] overflow-y-auto",children:[e.jsxs($e,{children:[e.jsx(K,{children:"Dodaj link do odcinka"}),e.jsxs(Te,{children:[s," - Dodaj lub zaktualizuj link do odcinka"]})]}),e.jsxs("div",{className:"space-y-4 overflow-visible",children:[e.jsxs("div",{children:[e.jsx(D,{htmlFor:"episode",children:"Odcinek"}),e.jsxs(O,{value:h.toString(),onValueChange:a=>u(parseInt(a)),children:[e.jsx($,{id:"episode",children:e.jsx(T,{})}),e.jsx(F,{className:"max-h-[300px]",position:"popper",sideOffset:5,children:De.map(a=>e.jsxs(j,{value:a.toString(),children:["Odcinek ",a,_.has(a)&&" ✓"]},a))})]})]}),e.jsxs("div",{children:[e.jsx(D,{htmlFor:"link",children:"Link do odcinka"}),e.jsx(Fe,{id:"link",value:n,onChange:a=>g(a.target.value),placeholder:"https://...",type:"url"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(D,{htmlFor:"quality",children:"Jakość"}),e.jsxs(O,{value:m,onValueChange:me,children:[e.jsx($,{id:"quality",children:e.jsx(T,{})}),e.jsxs(F,{children:[e.jsx(j,{value:"2160p",children:"4K (2160p)"}),e.jsx(j,{value:"1080p",children:"Full HD (1080p)"}),e.jsx(j,{value:"720p",children:"HD (720p)"}),e.jsx(j,{value:"480p",children:"SD (480p)"})]})]})]}),e.jsxs("div",{children:[e.jsx(D,{htmlFor:"language",children:"Język"}),e.jsxs(O,{value:B,onValueChange:pe,children:[e.jsx($,{id:"language",children:e.jsx(T,{})}),e.jsxs(F,{children:[e.jsx(j,{value:"PL",children:"Polski"}),e.jsx(j,{value:"ENG",children:"Angielski"}),e.jsx(j,{value:"PL/ENG",children:"PL/ENG"})]})]})]})]}),e.jsx(f,{onClick:ke,disabled:!n.trim()||H.isPending,className:"w-full",children:_.has(h)?"Zaktualizuj link":"Dodaj link"})]})]})]})]}),I||M?e.jsx("div",{className:"text-center py-4 text-foreground-secondary",children:"Ładowanie..."}):e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3",children:z?.episodes?.map(a=>{const l=_.get(a.episode_number);return e.jsxs("div",{id:`episode-${i}-s${t}-e${a.episode_number}`,className:`bg-background rounded-xl p-4 border transition-all group ${ye.has(`${t}_${a.episode_number}`)?"border-green-500/50 shadow-sm shadow-green-500/10":l?"border-border shadow-sm":"border-border/50 opacity-70"}`,children:[e.jsxs("div",{className:"flex items-start justify-between mb-3",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"flex items-center gap-2 mb-1",children:e.jsxs("span",{className:"text-xs font-bold text-primary",children:["Odcinek ",a.episode_number]})}),e.jsx("h4",{className:"font-bold text-sm line-clamp-2 leading-snug",children:a.name||`Odcinek ${a.episode_number}`})]}),c&&l&&e.jsx(f,{size:"icon",variant:"ghost",onClick:()=>we(a.episode_number),className:"h-8 w-8 text-destructive hover:bg-destructive/10 -mt-1 -mr-1",children:e.jsx(Y,{className:"w-4 h-4"})}),c&&!l&&e.jsx(f,{size:"icon",variant:"ghost",onClick:()=>{u(a.episode_number),x(!0)},className:"h-8 w-8 text-muted-foreground hover:text-primary -mt-1 -mr-1",title:"Dodaj link",children:e.jsx(ce,{className:"w-4 h-4"})})]}),l?e.jsx("div",{className:"space-y-0 mt-auto border-t border-border/50",children:l.links&&l.links.length>0?l.links.map((o,y)=>e.jsxs("div",{className:"flex items-center gap-2 hover:bg-primary/5 py-3 border-b border-border/50 last:border-0 transition-colors group/link",children:[e.jsxs("button",{onClick:w=>Q(o.url,a.episode_number,w),className:"flex items-center gap-2 text-sm text-primary hover:underline flex-1 min-w-0 text-left",children:[e.jsx(ee,{className:"w-4 h-4 flex-shrink-0"}),e.jsxs("span",{className:"flex-1 min-w-0 truncate font-medium",children:[o.provider,o.version&&e.jsxs("span",{className:"text-foreground-secondary ml-1.5 opacity-80 decoration-0 font-normal",children:[" • ",o.version]})]})]}),c&&e.jsx(f,{size:"icon",variant:"ghost",onClick:w=>{w.stopPropagation(),_e(a.episode_number,y)},className:"h-6 w-6 text-destructive/70 hover:text-destructive hover:bg-destructive/10",children:e.jsx(Y,{className:"w-3.5 h-3.5"})})]},y)):l.link?e.jsxs("button",{onClick:o=>Q(l.link,a.episode_number,o),className:"w-full flex items-center justify-center gap-2 p-2.5 bg-primary text-primary-foreground rounded-lg hover:bg-primary/90 transition-colors text-sm font-semibold",children:[e.jsx(ee,{className:"w-4 h-4 fill-current"}),"Odtwórz"]}):null}):e.jsx("div",{className:"mt-auto",children:e.jsx("p",{className:"text-[11px] text-muted-foreground italic",children:"Brak dostępnych linków"})})]},a.id)})}),e.jsx(G,{open:N,onOpenChange:U,children:e.jsxs(J,{className:"max-w-7xl w-full h-[90vh] p-0","aria-describedby":void 0,children:[e.jsx(K,{className:"sr-only",children:"Odtwarzacz wideo"}),e.jsx("div",{className:"relative w-full h-full bg-black",children:e.jsx("iframe",{src:xe,className:"w-full h-full",allowFullScreen:!0,allow:"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture",title:"Video Player",sandbox:"allow-scripts allow-same-origin allow-presentation"})})]})}),e.jsx(se,{open:ge,onOpenChange:A,children:e.jsxs(ae,{children:[e.jsxs(ne,{children:[e.jsx(ie,{children:"Usunąć link?"}),e.jsx(te,{children:"Czy na pewno chcesz usunąć ten link? Ta operacja jest nieodwracalna."})]}),e.jsxs(le,{children:[e.jsx(re,{children:"Anuluj"}),e.jsx(oe,{onClick:Se,children:"Usuń"})]})]})}),e.jsx(se,{open:je,onOpenChange:L,children:e.jsxs(ae,{children:[e.jsxs(ne,{children:[e.jsx(ie,{children:"Usunąć wszystkie linki?"}),e.jsx(te,{children:"Czy na pewno chcesz usunąć wszystkie linki tego odcinka? Ta operacja jest nieodwracalna."})]}),e.jsxs(le,{children:[e.jsx(re,{children:"Anuluj"}),e.jsx(oe,{onClick:Ne,children:"Usuń wszystkie"})]})]})})]})},ws=()=>{const{id:i}=Re(),t=Ve(),p=Ie(),{data:s,isLoading:b,error:k}=Qe(parseInt(i||"0")),[c,v]=r.useState(null),[d,x]=r.useState(!1),{isAdmin:h}=C(),u=p.state;return r.useEffect(()=>{u?.initialSeason&&v(u.initialSeason)},[u]),r.useEffect(()=>{s?.seasons&&u?.initialSeason&&(s.seasons.findIndex(m=>m.season_number===u.initialSeason),s.seasons.filter(m=>m.season_number>0).findIndex(m=>m.season_number===u.initialSeason)>=3&&x(!0))},[s,u]),b?e.jsx("div",{className:"flex items-center justify-center min-h-screen",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-primary"})}):k||!s?e.jsxs("div",{className:"flex flex-col items-center justify-center min-h-screen gap-4",children:[e.jsx("p",{className:"text-foreground-secondary",children:"Brak wyników"}),e.jsxs(f,{onClick:()=>t("/series"),children:[e.jsx(de,{className:"w-4 h-4 mr-2"}),"Powrót"]})]}):e.jsxs(Me.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"min-h-screen",children:[e.jsxs("div",{className:"relative h-[50vh] md:h-[60vh] -mx-6 lg:-mx-8 -mt-6 lg:-mt-8 mb-8 overflow-hidden",children:[e.jsx("div",{className:"absolute top-6 left-6 z-10",children:e.jsxs(f,{variant:"ghost",onClick:()=>t("/series"),className:"gap-2 bg-black/50 hover:bg-black/70 backdrop-blur-sm",children:[e.jsx(de,{className:"w-4 h-4"}),"Powrót"]})}),e.jsx("img",{src:X.getImageUrl(s.backdrop_path||s.poster_path,"original"),alt:s.name,className:"w-full h-full object-cover object-top"}),e.jsx("div",{className:"absolute inset-0 bg-gradient-to-t from-background via-background/50 to-transparent"}),e.jsx("div",{className:"absolute bottom-0 left-0 right-0 p-6 lg:p-8",children:e.jsxs("div",{className:"max-w-4xl",children:[e.jsx("h1",{className:"text-4xl md:text-6xl font-bold mb-4",children:s.name}),s.tagline&&e.jsx("p",{className:"text-xl text-foreground-secondary italic mb-6",children:s.tagline})]})})]}),e.jsxs("div",{className:"max-w-6xl mx-auto space-y-8",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-6",children:[e.jsx(Ge,{tmdbId:s.id,type:"tv",title:s.name,posterPath:s.poster_path}),e.jsx(Xe,{movieId:`tmdb_${s.id}`,title:s.name,type:"series",year:s.first_air_date?new Date(s.first_air_date).getFullYear():void 0}),s.vote_average>0&&e.jsxs("div",{className:"flex items-center gap-2 bg-primary/20 px-4 py-2 rounded-lg",children:[e.jsx(ns,{className:"w-5 h-5 text-primary fill-current"}),e.jsx("span",{className:"text-2xl font-bold",children:s.vote_average.toFixed(1)}),e.jsx("span",{className:"text-foreground-secondary text-sm",children:"/ 10"})]}),s.first_air_date&&e.jsxs("div",{className:"flex items-center gap-2 text-foreground-secondary",children:[e.jsx(es,{className:"w-5 h-5"}),e.jsx("span",{className:"text-lg",children:new Date(s.first_air_date).getFullYear()})]}),s.episode_run_time&&s.episode_run_time[0]&&e.jsxs("div",{className:"flex items-center gap-2 text-foreground-secondary",children:[e.jsx(ss,{className:"w-5 h-5"}),e.jsxs("span",{className:"text-lg",children:[s.episode_run_time[0]," min"]})]}),s.status&&e.jsx("div",{className:"px-4 py-2 bg-background-secondary rounded-lg text-lg",children:s.status})]}),s.genres&&s.genres.length>0&&e.jsx("div",{className:"flex flex-wrap gap-3",children:s.genres.map(n=>e.jsx("span",{className:"px-4 py-2 bg-primary/10 text-primary rounded-full text-base font-medium",children:n.name},n.id))}),s.number_of_seasons&&s.number_of_seasons>0&&e.jsxs("div",{className:"bg-background-secondary rounded-xl p-6 lg:p-8",children:[e.jsx("h2",{className:"text-2xl font-bold mb-6",children:"Sezony i Odcinki"}),e.jsx("div",{className:"space-y-4",children:s.seasons?.filter(n=>n.season_number>0).slice(0,d?void 0:3).map(n=>e.jsxs("div",{className:"bg-background rounded-lg border border-border overflow-hidden",children:[e.jsxs("button",{onClick:()=>v(c===n.season_number?null:n.season_number),"aria-expanded":c===n.season_number,"aria-controls":`season-content-${n.season_number}`,className:"w-full p-4 flex items-center gap-4 hover:bg-background/80 transition-colors",children:[n.poster_path&&e.jsx("img",{src:X.getImageUrl(n.poster_path,"w200"),alt:n.name,className:"w-12 h-18 object-cover rounded"}),e.jsxs("div",{className:"flex-1 text-left",children:[e.jsx("h3",{className:"font-semibold text-lg",children:n.name}),e.jsxs("p",{className:"text-sm text-foreground-secondary",children:[n.episode_count," ",n.episode_count===1?"odcinek":"odcinków",n.air_date&&` • ${new Date(n.air_date).getFullYear()}`]})]}),e.jsx("div",{className:"text-foreground-secondary",children:c===n.season_number?"▼":"▶"})]}),c===n.season_number&&e.jsx("div",{className:"p-4 border-t border-border",id:`season-content-${n.season_number}`,children:e.jsx(rs,{tmdbId:s.id,seasonNumber:n.season_number,episodeCount:n.episode_count,seasonName:n.name,seriesName:s.name,targetEpisode:u?.initialSeason===n.season_number?u.initialEpisode:void 0})})]},n.id))}),s.seasons&&s.seasons.filter(n=>n.season_number>0).length>3&&e.jsx("div",{className:"mt-4 flex justify-center",children:e.jsx(f,{variant:"outline",onClick:()=>x(!d),className:"w-full sm:w-auto",children:d?e.jsx(e.Fragment,{children:"Pokaż mniej"}):e.jsxs(e.Fragment,{children:["Pokaż więcej (",s.seasons.filter(n=>n.season_number>0).length,")"]})})}),e.jsx("div",{className:"mt-6 pt-4 border-t border-border",children:e.jsxs("p",{className:"text-foreground-secondary",children:[e.jsx("span",{className:"font-semibold",children:s.number_of_seasons})," ",s.number_of_seasons===1?"sezon":"sezonów"," •",e.jsx("span",{className:"font-semibold ml-1",children:s.number_of_episodes})," ",s.number_of_episodes===1?"odcinek":"odcinków"," łącznie"]})})]}),e.jsxs("div",{className:"bg-background-secondary rounded-xl p-6 lg:p-8",children:[e.jsx("h2",{className:"text-2xl font-bold mb-4",children:"Opis"}),e.jsx("p",{className:"text-foreground-secondary text-lg leading-relaxed",children:s.overview||"Brak opisu"})]}),(()=>{const n=[];return s.popularity>0&&n.push({label:"Popularność",value:s.popularity.toFixed(0)}),s.vote_count>0&&n.push({label:"Liczba głosów",value:s.vote_count.toLocaleString()}),s.spoken_languages&&s.spoken_languages.length>0&&n.push({label:"Języki",value:s.spoken_languages.map(g=>g.name).join(", ")}),s.production_companies&&s.production_companies.length>0&&n.push({label:"Produkcja",value:s.production_companies[0].name}),n.length>0?e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6",children:n.map((g,m)=>e.jsxs("div",{className:"bg-background-secondary rounded-xl p-6",children:[e.jsx("h3",{className:"text-sm text-foreground-secondary mb-2",children:g.label}),e.jsx("p",{className:"text-2xl font-bold",children:g.value})]},m))}):null})(),e.jsx(as,{tmdbId:s.id,type:"tv",mediaTitle:s.name})]})]})};export{ws as default};
